<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>axios</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js'></script>
</head>

<body>


    <div id='app'>
        <div>
            书名：《__name__》 数量：<span id='number'>__number__</span>
        </div>
        <div>
            <button id='addOne'>+</button>
            <button id='minusOne'>-</button>
            <button id='reset'>0</button>
        </div>
    </div>
</body>

<script>
    fakeData()
        // 上面是假的后台


    function Model(options) {
        this.data = options.data
        this.resouce = options.resouce
    }
    Model.prototype.fetch = function(id) {
        return axios.get(`/${this.resouce}s/${id}`).then((response) => {
            this.data = response.data
            return response
        })
    }
    Model.prototype.updata = function(data) {
        let id = this.data.id
        return axios.put(`/${this.resouce}s/${id}`, data).then((response) => {
            this.data = response.data
            console.log('response.data')
            console.log(response)
            console.log('data')
            console.log(data)
            console.log('id')
            console.log(id)
            return response
        })
    }


    //上面是MVC类，下面是对象
    let model = new Model({
        data: {
            name: '',
            number: 0,
            id: '1'
        },
        resouce: 'book'
    })

    function View({
        el,
        template
    }) {
        this.el = el
        this.template = template
    }
    View.prototype.render = function(data) {
        let html = this.template
        for (let key in data) {
            html = html.replace(`__${key}__`, data[key])
        }

        $(this.el).html(html)
    }






    // let model = {
    //     data: {
    //         name: '',
    //         number: 0,
    //         id: '1'
    //     },
    //     fetch(id) {
    //         return axios.get(`/books/${id}`).then((response) => {
    //             this.data = response.data
    //             return response
    //         })
    //     },
    //     updata(data) {
    //         let id = this.data.id
    //         return axios.put(`/books/${id}`, data).then((response) => {
    //             this.data = response.data
    //             console.log('response.data')
    //             console.log(response)
    //             console.log('data')
    //             console.log(data)
    //             console.log('id')
    //             console.log(id)
    //             return response
    //         })
    //     }


    // }


    let view = new View({
        el: '#app',
        template: ` 
        <div>
            书名：《__name__》 数量：<span id='number'>__number__</span>
        </div>
        <div>
            <button id='addOne'>+</button>
            <button id='minusOne'>-</button>
            <button id='reset'>0</button>
        </div>
        `,
        render(data) {
            let html = this.template.replace('__name__', data.name)
                .replace('__number__', data.number)
            $(this.el).html(html)
        }
    })


    var controller = {
        init(options) {
            let view = options.view
            let model = options.model
            this.view = view
            this.model = model
            this.view.render(this.model.data)
            this.bindEvents()
            this.model.fetch(1)
                .then(() => {

                    this.view.render(this.model.data)
                })
        },
        addOne() {

            var oldNumber = $('#number').text()
            var newNumber = oldNumber - 0 + 1
            this.model.updata({
                number: newNumber
            }).then(() => {

                this.view.render(this.model.data)
            }, () => {})


        },
        minusOne() {

            var oldNumber = $('#number').text()
            var newNumber = oldNumber - 0 - 1

            this.model.updata({
                number: newNumber
            }).then(() => {
                this.view.render(this.model.data)
            })

        },
        reset() {


            this.model.updata({
                number: 0
            }).then(() => {
                this.view.render(this.model.data)
            })

        },
        bindEvents() {

            $(this.view.el).on('click', '#addOne', this.addOne.bind(this))
            $(this.view.el).on('click', '#minusOne', this.minusOne.bind(this))
            $(this.view.el).on('click', '#reset', this.reset.bind(this))
        }
    }


    controller.init({
        view: view,
        model: model
    })




















    //不要看
    function fakeData() {
        let book = {
            'name': 'js高级程序设计',
            'number': 2,
            'id': 1
        }
        axios.interceptors.response.use(function(response) {

            let {
                config: {
                    method,
                    url,
                    data
                }
            } = response
            if (url === '/books/1' && method === 'get') {
                response.data = book
                console.log('book')
                console.log(book)
            } else if (url === '/books/1' && method === 'put') {
                data = JSON.parse(data)
                Object.assign(book, data)
                console.log('book')
                console.log(book)
                response.data = book
            }

            return response
        })
    }
</script>

</html>